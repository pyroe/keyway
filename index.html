<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚€è¯·ç å…‘æ¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .announcement {
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .content {
            padding: 40px;
        }
        
        .invite-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        
        .invite-input {
            padding: 16px 20px;
            font-size: 1.1rem;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .invite-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }
        
        .invite-input::placeholder {
            color: #aaa;
        }
        
        .activate-btn {
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }
        
        .activate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(79, 172, 254, 0.4);
        }
        
        .activate-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 25px;
            border-radius: 12px;
            display: none;
        }
        
        .result.success {
            background-color: #e8f7ef;
            border: 2px solid #28a745;
            display: block;
        }
        
        .result.error {
            background-color: #fde8e8;
            border: 2px solid #dc3545;
            display: block;
        }
        
        .result h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .account-info {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .account-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .account-row:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .account-label {
            font-weight: 600;
            width: 80px;
            color: #555;
        }
        
        .account-value {
            color: #333;
            font-weight: 500;
        }
        
        .cooldown-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            height: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .container {
                max-width: 100%;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .announcement {
                padding: 15px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="announcement" id="announcement">æ¬¢è¿ä½¿ç”¨é‚€è¯·ç å…‘æ¢ç³»ç»Ÿ</div>
        <div class="content">
            <form class="invite-form" id="inviteForm">
                <div class="input-group">
                    <label for="inviteCode">è¯·è¾“å…¥æ‚¨çš„é‚€è¯·ç ï¼š</label>
                    <input type="text" id="inviteCode" class="invite-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚€è¯·ç " maxlength="20" required>
                    <!-- å·²ç§»é™¤å¯¹ç‰¹æ®Šå­—ç¬¦çš„é™åˆ¶ -->
                </div>
                <button type="submit" class="activate-btn" id="activateBtn">æ¿€æ´»é‚€è¯·ç </button>
                <div class="cooldown-text" id="cooldownText"></div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨éªŒè¯é‚€è¯·ç ï¼Œè¯·ç¨å€™...</p>
                </div>
            </form>
            <div class="result" id="result"></div>
        </div>
    </div>

    <script>
        // ==================== NocoDB é…ç½® ====================
        // !!! è¯·åŠ¡å¿…ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼Œä¸ä½ çš„NocoDBå®ä¾‹åŒ¹é… !!!
        const CONFIG = {
            // NocoDB æœåŠ¡å™¨åœ°å€ (æœ«å°¾ä¸è¦åŠ æ–œæ )
            SERVER_URL: "http://localhost:8080",
            // ä½ çš„ API è®¿é—®ä»¤ç‰Œ (ä»NocoDBåå°å·¦ä¸‹è§’ ç”¨æˆ·å¤´åƒ -> API Tokens è·å–)
            API_TOKEN: "CCCCCC",
            // é¡¹ç›®åç§°ï¼ˆä½ åœ¨NocoDBä¸­åˆ›å»ºçš„BASE IDï¼‰
            PROJECT_NAME: "CCCCCC",
            // æ•°æ®è¡¨åç§°ï¼ˆä½ åœ¨BASEä¸­åˆ›å»ºçš„TABLE IDï¼‰
            TABLE_NAME: "CCCCCC",
            // å­—æ®µæ˜ å°„ï¼ˆå¿…é¡»ä¸ä½ åœ¨NocoDBä¸­è®¾ç½®çš„FIELD IDå®Œå…¨ä¸€è‡´ï¼‰
            FIELD_MAP: {
                INVITE_CODE: "invite_code",   // é‚€è¯·ç å­—æ®µå
                ACCOUNT: "account",           // è´¦å·å­—æ®µå
                PASSWORD: "password",         // å¯†ç å­—æ®µå
                STATUS: "status"              // çŠ¶æ€å­—æ®µå
            }
        };

        // ==================== å…¨å±€å˜é‡ ====================
        let isCooldown = false;
        let cooldownTimer = null;
        const COOLDOWN_TIME = 10;

        // ==================== DOM å…ƒç´  ====================
        const inviteForm = document.getElementById('inviteForm');
        const inviteCodeInput = document.getElementById('inviteCode');
        const activateBtn = document.getElementById('activateBtn');
        const cooldownText = document.getElementById('cooldownText');
        const loading = document.getElementById('loading');
        const resultDiv = document.getElementById('result');

        // ==================== NocoDB API å‡½æ•° ====================

        /**
         * åœ¨ NocoDB è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„é‚€è¯·ç è®°å½•
         * @param {string} code - ç”¨æˆ·è¾“å…¥çš„é‚€è¯·ç 
         * @returns {Promise<Object|null>} æ‰¾åˆ°çš„è®°å½•æˆ–null
         */
        async function findInviteCode(code) {
            // NocoDB Filter API: ç²¾ç¡®æŸ¥æ‰¾ invite_code åˆ—ç­‰äºè¾“å…¥å€¼çš„è®°å½•
            const filter = JSON.stringify({
                where: `(${CONFIG.FIELD_MAP.INVITE_CODE},eq,${code})`
            });

            try {
                const response = await fetch(
                    `${CONFIG.SERVER_URL}/api/v1/db/data/noco/${CONFIG.PROJECT_NAME}/${CONFIG.TABLE_NAME}?filter=${encodeURIComponent(filter)}`,
                    {
                        headers: {
                            'xc-token': CONFIG.API_TOKEN,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (!response.ok) throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status}`);

                const data = await response.json();
                // è¿”å›æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ï¼ˆé‚€è¯·ç åº”å”¯ä¸€ï¼‰
                return data.list && data.list.length > 0 ? data.list[0] : null;

            } catch (error) {
                console.error("æŸ¥è¯¢é‚€è¯·ç å¤±è´¥:", error);
                throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
        }

        /**
         * æ›´æ–°è®°å½•çŠ¶æ€ä¸ºâ€œå·²æ¿€æ´»â€
         * @param {string} recordId - è®°å½•çš„å”¯ä¸€ID
         * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸ
         */
        async function activateRecord(recordId) {
            try {
                const response = await fetch(
                    `${CONFIG.SERVER_URL}/api/v1/db/data/noco/${CONFIG.PROJECT_NAME}/${CONFIG.TABLE_NAME}/${recordId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'xc-token': CONFIG.API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            [CONFIG.FIELD_MAP.STATUS]: "å·²æ¿€æ´»"
                        })
                    }
                );

                if (!response.ok) throw new Error(`æ›´æ–°å¤±è´¥: ${response.status}`);
                return true;

            } catch (error) {
                console.error("æ›´æ–°è®°å½•çŠ¶æ€å¤±è´¥:", error);
                throw new Error("æ¿€æ´»çŠ¶æ€æ›´æ–°å¤±è´¥");
            }
        }

        // ==================== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ====================
        inviteForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const inviteCode = inviteCodeInput.value.trim();

            // åŸºç¡€éªŒè¯
            if (!inviteCode) {
                showError("è¯·è¾“å…¥é‚€è¯·ç ");
                return;
            }
            if (inviteCode.length > 20) {
                showError("é‚€è¯·ç é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦");
                return;
            }
            if (isCooldown) {
                showError("è¯·ç­‰å¾…å†·å´æ—¶é—´ç»“æŸ");
                return;
            }

            // å¼€å§‹å¤„ç†
            startCooldown();
            showLoading(true);

            try {
                // 1. æŸ¥æ‰¾è®°å½•
                const record = await findInviteCode(inviteCode);

                if (!record) {
                    showError("è¯¥é‚€è¯·ç æœ‰è¯¯ï¼Œä¸èƒ½ä½¿ç”¨");
                    return;
                }

                // 2. æ£€æŸ¥çŠ¶æ€
                const currentStatus = record[CONFIG.FIELD_MAP.STATUS];
                if (currentStatus === "å·²æ¿€æ´»") {
                    showError("è¯¥é‚€è¯·ç å·²ç»è¢«ä½¿ç”¨ï¼Œä¸èƒ½å†æ¬¡æ¿€æ´»");
                    return;
                }

                // 3. æ¿€æ´»è®°å½•
                const success = await activateRecord(record.Id);
                if (success) {
                    // 4. æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    showAccountInfo(
                        record[CONFIG.FIELD_MAP.ACCOUNT],
                        record[CONFIG.FIELD_MAP.PASSWORD]
                    );
                }

            } catch (error) {
                console.error("æ¿€æ´»æµç¨‹å‡ºé”™:", error);
                showError(`ç³»ç»Ÿé”™è¯¯: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // ==================== ç•Œé¢æ§åˆ¶å‡½æ•° ====================
        // (ä»¥ä¸‹å‡½æ•°ä¸ä¹‹å‰ç‰ˆæœ¬åŠŸèƒ½ç›¸åŒï¼Œç›´æ¥å¤ç”¨)
        // startCooldown(), updateCooldownText(), showLoading(), showError(), showAccountInfo()
        // è¯·ç¡®ä¿ showAccountInfo() å‡½æ•°èƒ½æ­£ç¡®æ˜¾ç¤ºåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å¯†ç 

        function startCooldown() {
            isCooldown = true;
            activateBtn.disabled = true;
            let remaining = COOLDOWN_TIME;
            updateCooldownText(remaining);
            
            cooldownTimer = setInterval(() => {
                remaining--;
                updateCooldownText(remaining);
                if (remaining <= 0) {
                    clearInterval(cooldownTimer);
                    isCooldown = false;
                    activateBtn.disabled = false;
                    cooldownText.textContent = "";
                }
            }, 1000);
        }

        function updateCooldownText(seconds) {
            cooldownText.textContent = `å†·å´æ—¶é—´: ${seconds}ç§’åå¯å†æ¬¡æ¿€æ´»`;
            cooldownText.style.color = "#ff6b6b";
        }

        function showLoading(show) {
            loading.style.display = show ? "block" : "none";
            activateBtn.style.display = show ? "none" : "block";
        }

        function showError(message) {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `<h3>æ¿€æ´»å¤±è´¥</h3><p>${message}</p>`;
            resultDiv.style.display = "block";
            setTimeout(() => { resultDiv.style.display = "none"; }, 5000);
        }

        function showAccountInfo(account, password) {
            // ç‰¹åˆ«æ³¨æ„ï¼šè¿™é‡Œç›´æ¥æ˜¾ç¤ºå¯†ç ï¼Œä¸åšä»»ä½•è½¬ä¹‰ï¼Œä»¥æ”¯æŒç‰¹æ®Šå­—ç¬¦
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                <h3>ğŸ‰ æ¿€æ´»æˆåŠŸï¼</h3>
                <p>è¯¥è´¦å·ç°åœ¨å·²æ¿€æ´»ï¼Œè¯·ä¿å­˜è´¦å·å’Œå¯†ç </p>
                <div class="account-info">
                    <div class="account-row">
                        <span class="account-label">è´¦å·:</span>
                        <span class="account-value">${account}</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">å¯†ç :</span>
                        <span class="account-value">${password}</span>
                    </div>
                </div>
                <p style="margin-top:15px; font-size:0.9rem; color:#666;">
                    âš ï¸ è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„è´¦å·å¯†ç ï¼Œæ­¤ä¿¡æ¯ä»…æ˜¾ç¤ºä¸€æ¬¡
                </p>
            `
            resultDiv.style.display = "block";
            inviteCodeInput.value = "";
        }

        // åˆå§‹åŒ–ï¼šç§»é™¤ä»»ä½•è¾“å…¥é™åˆ¶ï¼ˆå…è®¸ç‰¹æ®Šå­—ç¬¦ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log("NocoDBç‰ˆé‚€è¯·ç ç³»ç»Ÿå·²åŠ è½½");
            // ç¡®ä¿è¾“å…¥æ¡†æ— è¿‡æ»¤å™¨
            if (inviteCodeInput) {
                inviteCodeInput.addEventListener('input', function() {
                    // åªä¿ç•™é•¿åº¦æ£€æŸ¥ï¼Œä¸é™åˆ¶å­—ç¬¦ç±»å‹
                    if (this.value.length > 20) {
                        this.value = this.value.substring(0, 20);
                    }
                });
            }
        });
    </script>
</body>
</html>
